@{
    ViewData["Title"] = "Dashboard";
}

@await Html.PartialAsync("_DashboardHeader")

<div class="container">
    <div class="my-4" style="width: 40%">
        <div class="form-floating">
            <input type="text" class="form-control" id="studentNo" placeholder="Enter Student No." style="border-radius: 5px;" disabled>
            <label for="studentNo" style="color: #000;">Student No.</label>
        </div>
    </div>

    <p class="fw-bold fs-4">Scanner</p>

    <div id="scanner-container" class="my-4">
        <button id="openCamera" class="btn btn-primary mb-3">Open Camera</button>
        <button id="closeCamera" class="btn btn-secondary mb-3 ms-2" style="display: none;">Close Camera</button>
        <div class="row g-4">
            <div class="col-md-6">
                <div id="video-container" style="display: none; max-width: 500px; max-height: 500px; overflow: hidden; border-radius: 10px;">
                    <video id="video" width="100%" height="auto" style="border-radius: 10px;"></video>
                </div>
            </div>
            <div class="col-md-6">
                <div id="output" class="p-3" style="border: 1px solid #dee2e6; border-radius: 10px;">
                    <div class="d-flex flex-column align-items-center mb-3">
                        <div style="width: 150px; height: 150px; border: 1px solid #dee2e6; display: flex; justify-content: center; align-items: center;">
                        </div>
                        <span class="text-muted mt-2">LN, FN, MI</span>
                    </div>
                    <div>
                        <p><strong>Name:</strong> <span id="scannedName"></span></p>
                        <p><strong>SY:</strong> <span id="scannedSY"></span></p>
                        <p><strong>Sem:</strong> <span id="scannedSem"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/zxing/library@latest"></script>
    <script>
        let stream;
        let codeReader;

        document.getElementById('openCamera').addEventListener('click', function() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(function(videoStream) {
                        stream = videoStream;
                        var video = document.getElementById('video');
                        video.srcObject = stream;
                        video.play();
                        document.getElementById('video-container').style.display = 'block';
                        document.getElementById('closeCamera').style.display = 'inline-block';
                        document.getElementById('openCamera').style.display = 'none';
                        startScanning();
                    })
                    .catch(function(error) {
                        console.error("Error accessing the camera: ", error);
                    });
            }
        });

        document.getElementById('closeCamera').addEventListener('click', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById('video-container').style.display = 'none';
                document.getElementById('closeCamera').style.display = 'none';
                document.getElementById('openCamera').style.display = 'inline-block';
                if (codeReader) {
                    codeReader.reset();
                }
            }
        });

        function startScanning() {
            codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                if (result) {
                    document.getElementById('scannedDetails').textContent = result.text;
                    codeReader.reset();
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                }
            });
        }
    </script>
}
